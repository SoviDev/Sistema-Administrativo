{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0"><i class="bi bi-pencil"></i> Editar Tarea</h2>
        </div>
        <div class="card-body">
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    <strong>⚠️ Atención:</strong> {{ form.non_field_errors }}
                </div>
            {% endif %}

            <form method="POST">
                {% csrf_token %}
                
                <div class="mb-3">
                    <label for="id_titulo" class="form-label">Título</label>
                    {{ form.titulo }}
                    {% if form.titulo.errors %}
                        <div class="invalid-feedback d-block">{{ form.titulo.errors }}</div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label for="id_descripcion" class="form-label">Descripción</label>
                    {{ form.descripcion }}
                    {% if form.descripcion.errors %}
                        <div class="invalid-feedback d-block">{{ form.descripcion.errors }}</div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label for="id_estado" class="form-label">Estado</label>
                    {{ form.estado }}
                    {% if form.estado.errors %}
                        <div class="invalid-feedback d-block">{{ form.estado.errors }}</div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label for="id_departamento" class="form-label">Departamento</label>
                    {{ form.departamento }}
                    {% if form.departamento.errors %}
                        <div class="invalid-feedback d-block">{{ form.departamento.errors }}</div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label for="id_asignado_a" class="form-label">Asignado a</label>
                    {{ form.asignado_a }}
                    {% if form.asignado_a.errors %}
                        <div class="invalid-feedback d-block">{{ form.asignado_a.errors }}</div>
                    {% endif %}
                </div>

                <button type="submit" id="btn-guardar" class="btn btn-success">
                    <i class="bi bi-check-lg"></i> Guardar Cambios
                </button>
                <a href="{% url 'tareas:pendientes' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Cancelar
                </a>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const departamentoSelect = document.getElementById("id_departamento");
        const usuarioSelect = document.getElementById("id_asignado_a");
        const btnGuardar = document.getElementById("btn-guardar");
        let usuariosCargando = false;

        function cargarUsuarios(deptoId, usuarioSeleccionado = null) {
            if (!deptoId) {
                usuarioSelect.innerHTML = "<option value=''>---------</option>";
                return;
            }

            usuarioSelect.innerHTML = "<option value=''>Cargando usuarios...</option>";
            usuarioSelect.disabled = true;
            btnGuardar.disabled = true;
            usuariosCargando = true;

            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch(`{% url 'tareas:usuarios_departamento' 0 %}`.replace('0', deptoId), {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al obtener usuarios');
                }
                return response.json();
            })
            .then(usuarios => {
                usuarioSelect.innerHTML = "<option value=''>---------</option>";
                
                usuarios.forEach(usuario => {
                    const option = document.createElement('option');
                    option.value = usuario.id;
                    option.textContent = usuario.username;
                    usuarioSelect.appendChild(option);
                });

                // Restaurar usuario seleccionado si existe
                if (usuarioSeleccionado && usuarios.some(u => u.id == usuarioSeleccionado)) {
                    usuarioSelect.value = usuarioSeleccionado;
                }
            })
            .catch(error => {
                console.error("Error al obtener usuarios:", error);
                usuarioSelect.innerHTML = "<option value=''>Error al cargar usuarios</option>";
            })
            .finally(() => {
                usuarioSelect.disabled = false;
                usuariosCargando = false;
                btnGuardar.disabled = false;
            });
        }

        // Cargar usuarios al inicio si hay un departamento seleccionado
        if (departamentoSelect.value) {
            cargarUsuarios(departamentoSelect.value, "{{ form.asignado_a.value|default:'' }}");
        }

        // Manejar cambio de departamento
        departamentoSelect.addEventListener("change", function () {
            const usuarioActual = usuarioSelect.value;
            cargarUsuarios(this.value, usuarioActual);
        });

        // Validar antes de enviar
        document.querySelector("form").addEventListener("submit", function(event) {
            if (usuariosCargando) {
                event.preventDefault();
                alert("⚠️ Por favor, espera a que se carguen los usuarios antes de guardar.");
                return;
            }
        });
    });
</script>

{% endblock %}